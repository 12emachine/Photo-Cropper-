<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Image Cropper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {font-family: 'Inter', sans-serif; min-height: 100vh; margin:0; background:#f3f4f6;}
    canvas {display:block; background:#fff; border:2px dashed #d1d5db; max-width:100%; height:auto;
            border-radius:.75rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
            cursor:crosshair;}
    .hidden-input {display:none;}
  </style>
</head>
<body class="p-4 flex flex-col items-center justify-center">

<div class="w-full max-w-2xl bg-white p-6 md:p-8 rounded-2xl shadow-2xl space-y-6">
  <h1 class="text-3xl font-bold text-gray-800 text-center">Mobile Image Cropper</h1>
  <p class="text-center text-gray-500 mb-6">
    Upload → drag to select → crop → download.
  </p>

  <div class="flex flex-col sm:flex-row gap-4">
    <label for="imageUpload" class="flex-1 cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg text-center">
      Select Image
    </label>
    <input type="file" id="imageUpload" class="hidden-input" accept="image/*">

    <button id="cropButton" disabled class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50">
      Crop Selection
    </button>

    <button id="downloadButton" disabled class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50">
      Download Cropped
    </button>
  </div>

  <div id="canvasContainer" class="w-full relative min-h-64 flex items-center justify-center rounded-xl bg-gray-100 p-2">
    <p id="placeholderText" class="text-gray-400 text-lg absolute">Upload an image to start cropping...</p>
    <canvas id="imageCanvas"></canvas>
  </div>

  <div id="notification" class="hidden p-3 rounded-lg" role="alert"></div>
</div>

<script>
  const NOTIFY_MS = 3000;
  const MIN_CROP = 5;

  const canvas = document.getElementById('imageCanvas');
  const ctx = canvas.getContext('2d');
  const upload = document.getElementById('imageUpload');
  const cropBtn = document.getElementById('cropButton');
  const dlBtn = document.getElementById('downloadButton');
  const note = document.getElementById('notification');
  const placeholder = document.getElementById('placeholderText');
  const container = document.getElementById('canvasContainer');

  let img = null;
  let dragging = false;
  let rect = {sx:0, sy:0, ex:0, ey:0};
  let imgToCanvas = 1;

  const notify = (msg, type='error') => {
    note.textContent = msg;
    note.className = `p-3 border rounded-lg ${type==='success'?'bg-green-100 border-green-400 text-green-700':'bg-red-100 border-red-400 text-red-700'}`;
    note.classList.remove('hidden');
    setTimeout(()=>note.classList.add('hidden'), NOTIFY_MS);
  };

  const canvasPos = e => {
    const r = canvas.getBoundingClientRect();
    const ev = e.touches ? e.touches[0] : e;
    return {x: ev.clientX - r.left, y: ev.clientY - r.top};
  };

  const toImg = (cx,cy) => ({x: cx*imgToCanvas, y: cy*imgToCanvas});

  const draw = () => {
    if (!img) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    const sx = Math.min(rect.sx, rect.ex);
    const sy = Math.min(rect.sy, rect.ey);
    const w  = Math.abs(rect.ex - rect.sx);
    const h  = Math.abs(rect.ey - rect.sy);
    ctx.clearRect(sx,sy,w,h);
    ctx.save(); ctx.beginPath(); ctx.rect(sx,sy,w,h); ctx.clip();
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    ctx.restore();
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 3;
    ctx.strokeRect(sx,sy,w,h);
  };

  const resizeCanvas = () => {
    if (!img) return;
    const cw = container.clientWidth;
    const maxH = Math.min(window.innerHeight*0.8, 600);
    const ar = img.width / img.height;
    let width = cw, height = cw / ar;
    if (height > maxH) { height = maxH; width = maxH * ar; }
    canvas.width = Math.floor(width);
    canvas.height = Math.floor(height);
    imgToCanvas = img.width / canvas.width;
    rect = {sx:0, sy:0, ex:canvas.width, ey:canvas.height};
    placeholder.classList.add('hidden');
    canvas.style.display = 'block';
    draw();
    cropBtn.disabled = dlBtn.disabled = false;
  };

  upload.onchange = e => {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('image/')) return notify('Invalid image');
    const reader = new FileReader();
    reader.onload = ev => {
      const i = new Image();
      i.onload = () => { img = i; resizeCanvas(); };
      i.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  };

  const start = e => { if(!img) return; e.preventDefault(); dragging=true; const p=canvasPos(e); rect.sx=rect.ex=p.x; rect.sy=rect.ey=p.y; draw(); };
  const move  = e => { if(!dragging||!img) return; e.preventDefault(); const p=canvasPos(e); rect.ex=p.x; rect.ey=p.y; draw(); };
  const end   = () => { if(!img) return; dragging=false; const sx=Math.min(rect.sx,rect.ex), sy=Math.min(rect.sy,rect.ey), ex=Math.max(rect.sx,rect.ex), ey=Math.max(rect.sy,rect.ey); rect={sx,sy,ex,ey}; };

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  canvas.addEventListener('mouseup',   end);
  canvas.addEventListener('mouseout',  end);
  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove',  move,  {passive:false});
  canvas.addEventListener('touchend',   end);
  canvas.addEventListener('touchcancel',end);

  cropBtn.onclick = () => {
    if (!img) return notify('Load an image first');
    const w = Math.abs(rect.ex - rect.sx);
    const h = Math.abs(rect.ey - rect.sy);
    if (w<MIN_CROP || h<MIN_CROP) return notify('Selection too small');

    const src = toImg(Math.min(rect.sx,rect.ex), Math.min(rect.sy,rect.ey));
    const srcW = w * imgToCanvas;
    const srcH = h * imgToCanvas;

    const temp = document.createElement('canvas');
    temp.width = srcW; temp.height = srcH;
    const tctx = temp.getContext('2d');
    tctx.drawImage(img, src.x, src.y, srcW, srcH, 0,0, srcW, srcH);

    const newImg = new Image();
    newImg.onload = () => { img = newImg; resizeCanvas(); notify('Cropped!','success'); };
    newImg.src = temp.toDataURL('image/png');
  };

  /* ----------  FIXED DOWNLOAD ---------- */
  dlBtn.onclick = () => {
    if (!img) return notify('Nothing to download');

    const sx = Math.min(rect.sx, rect.ex);
    const sy = Math.min(rect.sy, rect.ey);
    const w  = Math.abs(rect.ex - rect.sx);
    const h  = Math.abs(rect.ey - rect.sy);

    if (w < MIN_CROP || h < MIN_CROP) return notify('Selection too small');

    const srcX = sx * imgToCanvas;
    const srcY = sy * imgToCanvas;
    const srcW = w  * imgToCanvas;
    const srcH = h  * imgToCanvas;

    const temp = document.createElement('canvas');
    temp.width  = srcW;
    temp.height = srcH;
    const tctx = temp.getContext('2d');
    tctx.drawImage(img, srcX, srcY, srcW, srcH, 0,0, srcW, srcH);

    temp.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cropped_${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      notify('Download started','success');
    }, 'image/png');
  };
  /* ------------------------------------- */

  canvas.style.display = 'none';
  window.addEventListener('resize', () => img && resizeCanvas());
</script>
</body>
</html>
